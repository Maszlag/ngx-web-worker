{"version":3,"file":"ngx-webworker.umd.js","sources":["ng://ngx-webworker/lib/webworker.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\n\ntype CallbackFunction = () => void;\n\n@Injectable()\nexport class WebworkerService {\n  private workerFunctionToUrlMap = new WeakMap<CallbackFunction, string>();\n  private promiseToWorkerMap = new WeakMap<Promise<any>, Worker>();\n\n  run<T>(workerFunction: (input: any) => T, data?: any): Promise<T> {\n    const url = this.getOrCreateWorkerUrl(workerFunction);\n    return this.runUrl(url, data);\n  }\n\n  runUrl(url: string, data?: any): Promise<any> {\n    const worker = new Worker(url);\n    const promise = this.createPromiseForWorker(worker, data);\n    const promiseCleaner = this.createPromiseCleaner(promise);\n\n    this.promiseToWorkerMap.set(promise, worker);\n\n    promise.then(promiseCleaner).catch(promiseCleaner);\n\n    return promise;\n  }\n\n  terminate<T>(promise: Promise<T>): Promise<T> {\n    return this.removePromise(promise);\n  }\n\n  getWorker(promise: Promise<any>): Worker {\n    return this.promiseToWorkerMap.get(promise);\n  }\n\n  private createPromiseForWorker<T>(worker: Worker, data: any) {\n    return new Promise<T>((resolve, reject) => {\n      worker.addEventListener('message', (event) => resolve(event.data));\n      worker.addEventListener('error', reject);\n      worker.postMessage(data);\n    });\n  }\n\n  private getOrCreateWorkerUrl(fn: any): string {\n    if (!this.workerFunctionToUrlMap.has(fn)) {\n      const url = this.createWorkerUrl(fn);\n      this.workerFunctionToUrlMap.set(fn, url);\n      return url;\n    }\n    return this.workerFunctionToUrlMap.get(fn);\n  }\n\n  private createWorkerUrl(resolve: CallbackFunction): string {\n    const resolveString = resolve.toString();\n    const webWorkerTemplate = `\n      self.addEventListener('message', function(e) {\n        postMessage((${resolveString})(e.data));\n      });\n    `;\n    const blob = new Blob([webWorkerTemplate], { type: 'text/javascript' });\n    return URL.createObjectURL(blob);\n  }\n\n  private createPromiseCleaner<T>(promise: Promise<T>): (input: any) => T {\n    return (event) => {\n      this.removePromise(promise);\n      return event;\n    };\n  }\n\n  private removePromise<T>(promise: Promise<T>): Promise<T> {\n    const worker = this.promiseToWorkerMap.get(promise);\n    if (worker) {\n      worker.terminate();\n    }\n    this.promiseToWorkerMap.delete(promise);\n    return promise;\n  }\n}\n"],"names":["Injectable"],"mappings":"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"}