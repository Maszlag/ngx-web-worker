{"version":3,"sources":["ng://@nitinkrmr/ngx-webworker/lib/webworker.service.ts"],"names":["WebworkerService","this","workerFunctionToUrlMap","WeakMap","promiseToWorkerMap","prototype","run","workerFunction","data","url","getOrCreateWorkerUrl","runUrl","worker","Worker","promise","createPromiseForWorker","promiseCleaner","createPromiseCleaner","set","then","catch","terminate","removePromise","getWorker","get","Promise","resolve","reject","addEventListener","event","postMessage","fn","has","createWorkerUrl","resolveString","toString","blob","Blob","type","URL","createObjectURL","_this","delete","Injectable"],"mappings":"qUAAA,IAAAA,EAAA,WAIA,SAAAA,IAEUC,KAAAC,uBAAyB,IAAIC,QAC7BF,KAAAG,mBAAqB,IAAID,QAsEnC,OApEEH,EAAAK,UAAAC,IAAA,SAAOC,EAAmCC,OAClCC,EAAMR,KAAKS,qBAAqBH,GACtC,OAAON,KAAKU,OAAOF,EAAKD,IAG1BR,EAAAK,UAAAM,OAAA,SAAOF,EAAaD,OACZI,EAAS,IAAIC,OAAOJ,GACpBK,EAAUb,KAAKc,uBAAuBH,EAAQJ,GAC9CQ,EAAiBf,KAAKgB,qBAAqBH,GAMjD,OAJAb,KAAKG,mBAAmBc,IAAIJ,EAASF,GAErCE,EAAQK,KAAKH,GAAgBI,SAAMJ,GAE5BF,GAGTd,EAAAK,UAAAgB,UAAA,SAAaP,GACX,OAAOb,KAAKqB,cAAcR,IAG5Bd,EAAAK,UAAAkB,UAAA,SAAUT,GACR,OAAOb,KAAKG,mBAAmBoB,IAAIV,IAG7Bd,EAAAK,UAAAU,uBAAR,SAAkCH,EAAgBJ,GAChD,OAAO,IAAIiB,QAAO,SAAKC,EAASC,GAC9Bf,EAAOgB,iBAAiB,UAAS,SAAGC,GAAU,OAAAH,EAAQG,EAAMrB,QAC5DI,EAAOgB,iBAAiB,QAASD,GACjCf,EAAOkB,YAAYtB,MAIfR,EAAAK,UAAAK,qBAAR,SAA6BqB,GAC3B,IAAK9B,KAAKC,uBAAuB8B,IAAID,GAAK,KAClCtB,EAAMR,KAAKgC,gBAAgBF,GAEjC,OADA9B,KAAKC,uBAAuBgB,IAAIa,EAAItB,GAC7BA,EAET,OAAOR,KAAKC,uBAAuBsB,IAAIO,IAGjC/B,EAAAK,UAAA4B,gBAAR,SAAwBP,OAChBQ,EAAgBR,EAAQS,WAMxBC,EAAO,IAAIC,KAAK,CALI,gFAEPH,EAAa,gCAGW,CAAEI,KAAM,oBACnD,OAAOC,IAAIC,gBAAgBJ,IAGrBpC,EAAAK,UAAAY,qBAAR,SAAgCH,GAAhC,IAAA2B,EAAAxC,KACE,OAAA,SAAQ4B,GAEN,OADAY,EAAKnB,cAAcR,GACZe,IAIH7B,EAAAK,UAAAiB,cAAR,SAAyBR,OACjBF,EAASX,KAAKG,mBAAmBoB,IAAIV,GAK3C,OAJIF,GACFA,EAAOS,YAETpB,KAAKG,mBAAmBsC,UAAO5B,GACxBA,uBAvEV6B,EAAAA,aAyED3C,EA7EA","sourcesContent":["import { Injectable } from '@angular/core';\n\ntype CallbackFunction = () => void;\n\n@Injectable()\nexport class WebworkerService {\n  private workerFunctionToUrlMap = new WeakMap<CallbackFunction, string>();\n  private promiseToWorkerMap = new WeakMap<Promise<any>, Worker>();\n\n  run<T>(workerFunction: (input: any) => T, data?: any): Promise<T> {\n    const url = this.getOrCreateWorkerUrl(workerFunction);\n    return this.runUrl(url, data);\n  }\n\n  runUrl(url: string, data?: any): Promise<any> {\n    const worker = new Worker(url);\n    const promise = this.createPromiseForWorker(worker, data);\n    const promiseCleaner = this.createPromiseCleaner(promise);\n\n    this.promiseToWorkerMap.set(promise, worker);\n\n    promise.then(promiseCleaner).catch(promiseCleaner);\n\n    return promise;\n  }\n\n  terminate<T>(promise: Promise<T>): Promise<T> {\n    return this.removePromise(promise);\n  }\n\n  getWorker(promise: Promise<any>): Worker {\n    return this.promiseToWorkerMap.get(promise);\n  }\n\n  private createPromiseForWorker<T>(worker: Worker, data: any) {\n    return new Promise<T>((resolve, reject) => {\n      worker.addEventListener('message', (event) => resolve(event.data));\n      worker.addEventListener('error', reject);\n      worker.postMessage(data);\n    });\n  }\n\n  private getOrCreateWorkerUrl(fn: any): string {\n    if (!this.workerFunctionToUrlMap.has(fn)) {\n      const url = this.createWorkerUrl(fn);\n      this.workerFunctionToUrlMap.set(fn, url);\n      return url;\n    }\n    return this.workerFunctionToUrlMap.get(fn);\n  }\n\n  private createWorkerUrl(resolve: CallbackFunction): string {\n    const resolveString = resolve.toString();\n    const webWorkerTemplate = `\n      self.addEventListener('message', function(e) {\n        postMessage((${resolveString})(e.data));\n      });\n    `;\n    const blob = new Blob([webWorkerTemplate], { type: 'text/javascript' });\n    return URL.createObjectURL(blob);\n  }\n\n  private createPromiseCleaner<T>(promise: Promise<T>): (input: any) => T {\n    return (event) => {\n      this.removePromise(promise);\n      return event;\n    };\n  }\n\n  private removePromise<T>(promise: Promise<T>): Promise<T> {\n    const worker = this.promiseToWorkerMap.get(promise);\n    if (worker) {\n      worker.terminate();\n    }\n    this.promiseToWorkerMap.delete(promise);\n    return promise;\n  }\n}\n"]}