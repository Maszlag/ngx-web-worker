{"version":3,"file":"n-abel-ngx-webworker.js","sources":["ng://@n-abel/ngx-webworker/lib/webworker.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\n\ntype CallbackFunction = () => void;\n\n@Injectable()\nexport class WebworkerService {\n  private workerFunctionToUrlMap = new WeakMap<CallbackFunction, string>();\n  private promiseToWorkerMap = new WeakMap<Promise<any>, Worker>();\n\n  run<T>(workerFunction: (input: any) => T, data?: any, enableAsync?: boolean): Promise<T> {\n    const url = this.getOrCreateWorkerUrl(workerFunction, enableAsync);\n    return this.runUrl(url, data);\n  }\n\n  runUrl(url: string, data?: any): Promise<any> {\n    const worker = new Worker(url);\n    const promise = this.createPromiseForWorker(worker, data);\n    const promiseCleaner = this.createPromiseCleaner(promise);\n\n    this.promiseToWorkerMap.set(promise, worker);\n\n    promise.then(promiseCleaner).catch(promiseCleaner);\n\n    return promise;\n  }\n\n  terminate<T>(promise: Promise<T>): Promise<T> {\n    return this.removePromise(promise);\n  }\n\n  getWorker(promise: Promise<any>): Worker {\n    return this.promiseToWorkerMap.get(promise);\n  }\n\n  private createPromiseForWorker<T>(worker: Worker, data: any) {\n    return new Promise<T>((resolve, reject) => {\n      worker.addEventListener('message', (event) => resolve(event.data));\n      worker.addEventListener('error', reject);\n      worker.postMessage(data);\n    });\n  }\n\n  private getOrCreateWorkerUrl(fn: any, enableAsync?: boolean): string {\n    if (!this.workerFunctionToUrlMap.has(fn)) {\n      const url = this.createWorkerUrl(fn, enableAsync);\n      this.workerFunctionToUrlMap.set(fn, url);\n      return url;\n    }\n    return this.workerFunctionToUrlMap.get(fn);\n  }\n\n  private createWorkerUrl(resolve: CallbackFunction, enableAsync?: boolean): string {\n    const resolveString = resolve.toString();\n    const webWorkerTemplate = `\n      self.addEventListener('message', function(e) {\n        ${!enableAsync ? 'postMessage' : ''}((${resolveString})(e.data));\n      });\n    `;\n    const blob = new Blob([webWorkerTemplate], { type: 'text/javascript' });\n    return URL.createObjectURL(blob);\n  }\n\n  private createPromiseCleaner<T>(promise: Promise<T>): (input: any) => T {\n    return (event) => {\n      this.removePromise(promise);\n      return event;\n    };\n  }\n\n  private removePromise<T>(promise: Promise<T>): Promise<T> {\n    const worker = this.promiseToWorkerMap.get(promise);\n    if (worker) {\n      worker.terminate();\n    }\n    this.promiseToWorkerMap.delete(promise);\n    return promise;\n  }\n}\n"],"names":[],"mappings":"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"}